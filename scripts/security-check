#!/usr/bin/env bash
set -e

STATUS=0
NO_FAIL=false
NO_GITHUB=false
OUTPUT_FILE="security-output.txt"
SUMMARY_FILE="security-output.md"
TMP_OUTPUT_NAME="tmp-security-output"

# Argument parsing
while [[ $# -gt 0 ]]; do
  case "$1" in
    --no-fail) NO_FAIL=true; shift ;;
    --no-github) NO_GITHUB=true; shift ;;
    --output)
      OUTPUT_FILE="$2"
      if [[ "$OUTPUT_FILE" == *.txt ]]; then
        SUMMARY_FILE="${OUTPUT_FILE%.txt}.md"
      else
        SUMMARY_FILE="${OUTPUT_FILE}.md"
      fi
      shift 2
      ;;
    *)
      echo "Unknown argument: $1"
      exit 1
      ;;
  esac
done

# Cleanup old files
[ -f "$SUMMARY_FILE" ] && rm "$SUMMARY_FILE"
[ -f "$OUTPUT_FILE" ] && rm "$OUTPUT_FILE"

append_output() { echo "$1" >> "$SUMMARY_FILE"; }
append_file_output() { cat "$1" >> "$SUMMARY_FILE"; }
line_break() { echo "" >> "$SUMMARY_FILE"; }
divider() { echo "---" >> "$SUMMARY_FILE"; }

run_script() {
  local script="$1"

  [ -f "$TMP_OUTPUT_NAME.md" ] && rm "$TMP_OUTPUT_NAME.md"
  [ -f "$TMP_OUTPUT_NAME.txt" ] && rm "$TMP_OUTPUT_NAME.txt"

  bash "$script" --output "$TMP_OUTPUT_NAME"
  local SCRIPT_STATUS=$?

  append_file_output "$TMP_OUTPUT_NAME.md"
  line_break
  divider
  line_break

  if [ $SCRIPT_STATUS -ne 0 ]; then
    STATUS=$SCRIPT_STATUS
  fi
}

# Header
append_output "## Security Check Report"
line_break
append_output "_Combined results from audit-deps, cargo-deny, and unsafe-scan._"
line_break
divider
line_break

# Run the three security tools
run_script audit-deps
run_script cargo-deny
run_script unsafe-scan

# Final summary
if [ $STATUS -ne 0 ] && [ "$NO_FAIL" = false ]; then
  append_output "❌ Security check failed."
  exit $STATUS
else
  append_output "✅ Security check completed."
fi

# Append to GitHub summary if enabled
if [ "$NO_GITHUB" = false ] && [ -f "$GITHUB_STEP_SUMMARY" ]; then
  cat "$SUMMARY_FILE" >> "$GITHUB_STEP_SUMMARY"
fi

exit $STATUS

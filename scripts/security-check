#!/usr/bin/env bash
set -e

NO_FAIL_ARG=""
if [[ "$1" == "--no-fail" ]]; then
    NO_FAIL_ARG="--no-fail"
fi

SUMMARY_FILE="${GITHUB_STEP_SUMMARY:-/tmp/summary.txt}"
ARTIFACT_FILE="security-summary.md"

# Clean previous output
: > "$SUMMARY_FILE"
: > "$ARTIFACT_FILE"

# Track overall results
AUDIT_RESULT="âœ…"
DENY_RESULT="âœ…"
UNSAFE_RESULT="âœ…"

header() {
    echo -e "$1\n" >> "$SUMMARY_FILE"
    echo -e "$1\n" >> "$ARTIFACT_FILE"
}

divider() {
    echo "---" >> "$SUMMARY_FILE"
    echo "---" >> "$ARTIFACT_FILE"
}

append_file() {
    cat "$1" >> "$SUMMARY_FILE"
    cat "$1" >> "$ARTIFACT_FILE"
}

write_summary_line() {
    echo "$1" >> "$SUMMARY_FILE"
    echo "$1" >> "$ARTIFACT_FILE"
}

### Top-Level Summary Header
header "## ğŸ” Rust Security Checks"
write_summary_line "_This summary includes results from audit, deny, and unsafe code scans._"
write_summary_line ""

### Cargo Audit
divider
header "### ğŸ“¦ Dependency Vulnerability Scan (cargo audit)"

audit-deps $NO_FAIL_ARG || AUDIT_RESULT="â—"

append_file "audit-output.txt"

### Cargo Deny
divider
header "### ğŸ“‹ Dependency Policy Check (cargo deny)"

cargo-deny $NO_FAIL_ARG || DENY_RESULT="âŒ"

append_file "deny-output.txt"

### Unsafe Scan
divider
header "### ğŸ§¯ Unsafe Code Detection (cargo geiger)"

unsafe-scan $NO_FAIL_ARG || UNSAFE_RESULT="âš ï¸"

append_file "geiger-output.txt"

### Final Summary Block
divider
header "### ğŸ§¾ Final Summary"

write_summary_line "| Check                 | Status |"
write_summary_line "|-----------------------|--------|"
write_summary_line "| Cargo Audit           | $AUDIT_RESULT |"
write_summary_line "| Cargo Deny            | $DENY_RESULT |"
write_summary_line "| Unsafe Code Detection | $UNSAFE_RESULT |"

divider
write_summary_line "âœ… Security checks completed."


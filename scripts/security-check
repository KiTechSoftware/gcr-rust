#!/usr/bin/env bash
set -e

NO_FAIL_ARG=""
if [[ "$1" == "--no-fail" ]]; then
    NO_FAIL_ARG="--no-fail"
fi

SUMMARY_FILE="${GITHUB_STEP_SUMMARY:-/tmp/summary.txt}"
ARTIFACT_FILE="security-summary.md"

# Clean previous output
: > "$SUMMARY_FILE"
: > "$ARTIFACT_FILE"

# Track overall results
AUDIT_RESULT="‚úÖ"
DENY_RESULT="‚úÖ"
UNSAFE_RESULT="‚úÖ"

header() {
    echo -e "$1\n" >> "$SUMMARY_FILE"
    echo -e "$1\n" >> "$ARTIFACT_FILE"
}

divider() {
    echo "---" >> "$SUMMARY_FILE"
    echo "---" >> "$ARTIFACT_FILE"
}

append_file() {
    if [[ -f "$1" ]]; then
        cat "$1" >> "$SUMMARY_FILE"
        cat "$1" >> "$ARTIFACT_FILE"
    else
        echo "_(file missing: $1)_" >> "$SUMMARY_FILE"
        echo "_(file missing: $1)_" >> "$ARTIFACT_FILE"
    fi
}

write_summary_line() {
    echo "$1" >> "$SUMMARY_FILE"
    echo "$1" >> "$ARTIFACT_FILE"
}

### Top-Level Summary Header
header "## üîê Rust Security Checks"
write_summary_line "_This summary includes results from audit, deny, and unsafe code scans._"
write_summary_line ""

### Cargo Audit
divider
header "### üì¶ Dependency Vulnerability Scan (cargo audit)"

audit-deps $NO_FAIL_ARG > audit-output.txt 2>&1 || AUDIT_RESULT="‚ùó"
append_file "audit-output.txt"

### Cargo Deny
divider
header "### üìã Dependency Policy Check (cargo deny)"

# Correct cargo-deny invocation
cargo deny check $NO_FAIL_ARG > deny-output.txt 2>&1 || DENY_RESULT="‚ùå"
append_file "deny-output.txt"

### Unsafe Scan
divider
header "### üßØ Unsafe Code Detection (cargo geiger)"

unsafe-scan $NO_FAIL_ARG > geiger-output.txt 2>&1 || UNSAFE_RESULT="‚ö†Ô∏è"
append_file "geiger-output.txt"

### Final Summary Block
divider
header "### üßæ Final Summary"

write_summary_line "| Check                 | Status |"
write_summary_line "|-----------------------|--------|"
write_summary_line "| Cargo Audit           | $AUDIT_RESULT |"
write_summary_line "| Cargo Deny            | $DENY_RESULT |"
write_summary_line "| Unsafe Code Detection | $UNSAFE_RESULT |"

divider
write_summary_line "‚úÖ Security checks completed."

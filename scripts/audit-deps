#!/usr/bin/env bash
set -e

STATUS=0
NO_FAIL=false
NO_GITHUB=false
OUTPUT_FILE="audit-output.txt"
SUMMARY_FILE="audit-output.md"

# Argument parsing
while [[ $# -gt 0 ]]; do
    case "$1" in
        --no-fail)
            NO_FAIL=true
            shift
            ;;
        --no-github)
            NO_GITHUB=true
            shift
            ;;
        --output)
            OUTPUT_FILE="$2"
            # Derive SUMMARY_FILE from OUTPUT_FILE if it ends in .txt
            if [[ "$OUTPUT_FILE" == *.txt ]]; then
                SUMMARY_FILE="${OUTPUT_FILE%.txt}.md"
            else
                SUMMARY_FILE="${OUTPUT_FILE}.md"
            fi
            shift 2
            ;;
        *)
            echo "Unknown argument: $1"
            exit 1
            ;;
    esac
done

# Cleanup old files
[ -f "$SUMMARY_FILE" ] && rm "$SUMMARY_FILE"
[ -f "$OUTPUT_FILE" ] && rm "$OUTPUT_FILE"

# Run audit
cargo audit 2>&1 | tee -a "$OUTPUT_FILE"

# Build summary
echo "### ðŸ“¦ Dependency Audit Summary (cargo audit)" > "$SUMMARY_FILE"
echo "" >> "$SUMMARY_FILE"
echo '```bash' >> "$SUMMARY_FILE"
cat "$OUTPUT_FILE" >> "$SUMMARY_FILE"
echo '```' >> "$SUMMARY_FILE"
echo "" >> "$SUMMARY_FILE"

# Check for vulnerabilities
if grep -q "Crate: " "$OUTPUT_FILE"; then
    echo "â— Vulnerabilities found." >> "$SUMMARY_FILE"
    $NO_FAIL || STATUS=1
else
    echo "âœ… No known vulnerabilities detected." >> "$SUMMARY_FILE"
fi

# Append to GitHub summary if enabled
if [ "$NO_GITHUB" = false ] && [ -f "$GITHUB_STEP_SUMMARY" ]; then
    cat "$SUMMARY_FILE" >> "$GITHUB_STEP_SUMMARY"
fi

exit $STATUS

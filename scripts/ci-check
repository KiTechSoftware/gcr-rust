#!/usr/bin/env bash
set -e

STATUS=0
SCRIPT_STATUS=0
NO_FAIL=false
NO_GITHUB=false
ARTIFACT_FILE="ci-artifact.md"
TMP_OUTPUT_NAME="tmp-ci-output"
for arg in "$@"; do
    if [[ "$arg" == "--no-fail" ]]; then
        NO_FAIL=true
    elif [[ "$arg" == "--no-github" ]]; then
        NO_GITHUB=true
    fi
done

# Cleanup old files
[ -f "$ARTIFACT_FILE" ] && rm "$ARTIFACT_FILE"

append_output() {
    echo "$1" >> "$ARTIFACT_FILE"
}
append_file_output() {
    cat "$1" >> "$ARTIFACT_FILE"
}
line_break() {
    echo "" >> "$ARTIFACT_FILE"
}
divider() {
    echo "---" >> "$ARTIFACT_FILE"
}

run_script() {
    local script="$1"
    # Cleanup old temporary files
    [ -f "$TMP_OUTPUT_NAME.md" ] && rm "$TMP_OUTPUT_NAME.md"
    [ -f "$TMP_OUTPUT_NAME.txt" ] && rm "$TMP_OUTPUT_NAME.txt"
    # run the script and return exit status
    SCRIPT_STATUS=$($script --output "$TMP_OUTPUT_NAME")
    append_file_output "$TMP_OUTPUT_NAME.md"
    # if the script failed, update the overall status
    if [ $SCRIPT_STATUS -ne 0 ]; then
        STATUS=$SCRIPT_STATUS
    fi
}

# Start summary
append_output "## ðŸ”§ Full CI Check Report"
line_break
append_output "_Includes security, linting, tests, and formatting checks._"
line_break
divider
line_break

# Run tools
run_script audit-deps
line_break
divider
run_script cargo-deny
line_break
divider
run_script unsafe-scan
line_break
divider
run_script clippy-check
line_break
divider
run_script fmt-check
line_break
divider
run_script nextest
line_break
divider
run_script test-coverage
line_break


# Final summary
if [ $STATUS -ne 0 ] && [ $NO_FAIL = false ]; then
    echo "âŒ CI check failed. See above for details." >> "$ARTIFACT_FILE"
else
    echo "âœ… CI check completed. See above for results." >> "$ARTIFACT_FILE"
fi

if [ -f "$GITHUB_STEP_SUMMARY" ]; then
    cat "$GITHUB_STEP_SUMMARY" >> "$ARTIFACT_FILE"
fi

exit $STATUS
